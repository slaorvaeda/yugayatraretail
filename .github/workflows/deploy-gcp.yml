name: Deploy to GCP Cloud Run

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  BACKEND_SERVICE: yugayatra-backend
  FRONTEND_SERVICE: yugayatra-frontend
  GCP_REGION: us-central1
  GCP_PROJECT_ID: yugayatraretail
  GCP_ARTIFACT_REGISTRY: yugayatraretail
  BACKEND_PORT: 5001
  FRONTEND_PORT: 3000

jobs:
  # CI Phase - Run tests and linting
  ci:
    name: CI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # Backend CI
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run backend linter
        working-directory: ./backend
        run: |
          if [ -f "eslint.config.js" ] || [ -f ".eslintrc.js" ]; then
            npm run lint || echo "‚ö†Ô∏è Linter warnings found"
          else
            echo "‚ÑπÔ∏è No linter configured for backend"
          fi

      - name: Run backend tests
        working-directory: ./backend
        run: |
          if npm run | grep -q "test"; then
            npm test
          else
            echo "‚ÑπÔ∏è No tests configured for backend"
          fi

      # Frontend CI
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run frontend linter
        working-directory: ./frontend
        run: npm run lint

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL || 'http://localhost:5001/api' }}

  # Build and Push Docker Images
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: ci
    timeout-minutes: 30
    permissions:
      contents: read
      actions: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Build Image Tags
        id: tags
        run: |
          set -e
          
          # Read secrets with fallbacks to env vars
          REGION="${{ secrets.GCP_REGION }}"
          PROJECT="${{ secrets.GCP_PROJECT_ID }}"
          REPO="${{ secrets.GCP_ARTIFACT_REGISTRY }}"
          
          # Remove whitespace and validate
          REGION=$(echo "$REGION" | xargs)
          PROJECT=$(echo "$PROJECT" | xargs)
          REPO=$(echo "$REPO" | xargs)
          
          # Apply hardcoded defaults if empty
          if [ -z "$REGION" ] || [ "$REGION" = "null" ] || [ "$REGION" = "" ]; then
            REGION="${{ env.GCP_REGION }}"
          fi
          
          if [ -z "$PROJECT" ] || [ "$PROJECT" = "null" ] || [ "$PROJECT" = "" ]; then
            PROJECT="${{ env.GCP_PROJECT_ID }}"
          fi
          
          if [ -z "$REPO" ] || [ "$REPO" = "null" ] || [ "$REPO" = "" ]; then
            REPO="${{ env.GCP_ARTIFACT_REGISTRY }}"
          fi
          
          # Final validation
          if [ -z "$REGION" ] || [ -z "$PROJECT" ] || [ -z "$REPO" ]; then
            echo "‚ùå ERROR: REGION, PROJECT, or REPO is empty!"
            exit 1
          fi
          
          echo "‚úÖ Using values:"
          echo "  REGION=$REGION"
          echo "  PROJECT=$PROJECT"
          echo "  REPO=$REPO"
          
          # Build image tags
          BACKEND_SHA="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/backend:${GITHUB_SHA}"
          BACKEND_LATEST="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/backend:latest"
          FRONTEND_SHA="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/frontend:${GITHUB_SHA}"
          FRONTEND_LATEST="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/frontend:latest"
          
          # Validate tags don't start with dash
          if [[ "$BACKEND_SHA" == -* ]] || [[ "$FRONTEND_SHA" == -* ]]; then
            echo "‚ùå ERROR: Image tag starts with dash! REGION is missing."
            echo "BACKEND_SHA: $BACKEND_SHA"
            echo "FRONTEND_SHA: $FRONTEND_SHA"
            exit 1
          fi
          
          echo "BACKEND_SHA=$BACKEND_SHA" >> $GITHUB_OUTPUT
          echo "BACKEND_LATEST=$BACKEND_LATEST" >> $GITHUB_OUTPUT
          echo "FRONTEND_SHA=$FRONTEND_SHA" >> $GITHUB_OUTPUT
          echo "FRONTEND_LATEST=$FRONTEND_LATEST" >> $GITHUB_OUTPUT
          echo "BACKEND_TAGS=$BACKEND_SHA,$BACKEND_LATEST" >> $GITHUB_OUTPUT
          echo "FRONTEND_TAGS=$FRONTEND_SHA,$FRONTEND_LATEST" >> $GITHUB_OUTPUT
          echo "REGION=$REGION" >> $GITHUB_OUTPUT
          echo "PROJECT=$PROJECT" >> $GITHUB_OUTPUT
          echo "REPO=$REPO" >> $GITHUB_OUTPUT
          
          echo ""
          echo "‚úÖ Image tags created:"
          echo "  Backend SHA: $BACKEND_SHA"
          echo "  Backend Latest: $BACKEND_LATEST"
          echo "  Frontend SHA: $FRONTEND_SHA"
          echo "  Frontend Latest: $FRONTEND_LATEST"

      - name: Configure Docker for Artifact Registry
        run: |
          REGION="${{ steps.tags.outputs.REGION }}"
          echo "Configuring Docker for: ${REGION}-docker.pkg.dev"
          gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.BACKEND_TAGS }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.FRONTEND_TAGS }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL || 'https://yugayatra-backend-xxxxx-uc.a.run.app/api' }}

  # Deploy Backend
  deploy-backend:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Set deployment values
        id: deploy-values
        run: |
          set -e
          
          # Read secrets with fallbacks
          REGION="${{ secrets.GCP_REGION }}"
          PROJECT="${{ secrets.GCP_PROJECT_ID }}"
          REPO="${{ secrets.GCP_ARTIFACT_REGISTRY }}"
          
          # Remove whitespace
          REGION=$(echo "$REGION" | xargs)
          PROJECT=$(echo "$PROJECT" | xargs)
          REPO=$(echo "$REPO" | xargs)
          
          # Apply defaults
          if [ -z "$REGION" ] || [ "$REGION" = "null" ] || [ "$REGION" = "" ]; then
            REGION="${{ env.GCP_REGION }}"
          fi
          
          if [ -z "$PROJECT" ] || [ "$PROJECT" = "null" ] || [ "$PROJECT" = "" ]; then
            PROJECT="${{ env.GCP_PROJECT_ID }}"
          fi
          
          if [ -z "$REPO" ] || [ "$REPO" = "null" ] || [ "$REPO" = "" ]; then
            REPO="${{ env.GCP_ARTIFACT_REGISTRY }}"
          fi
          
          # Build image tag
          BACKEND_IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/backend:${GITHUB_SHA}"
          
          # Validate tag
          if [[ "$BACKEND_IMAGE" == -* ]]; then
            echo "‚ùå ERROR: Image tag starts with dash! REGION is missing."
            exit 1
          fi
          
          echo "REGION=$REGION" >> $GITHUB_OUTPUT
          echo "PROJECT=$PROJECT" >> $GITHUB_OUTPUT
          echo "REPO=$REPO" >> $GITHUB_OUTPUT
          echo "BACKEND_IMAGE=$BACKEND_IMAGE" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Deployment values:"
          echo "  REGION=$REGION"
          echo "  PROJECT=$PROJECT"
          echo "  BACKEND_IMAGE=$BACKEND_IMAGE"

      - name: Deploy Backend to Cloud Run
        id: deploy-backend
        run: |
          set -e
          
          REGION="${{ steps.deploy-values.outputs.REGION }}"
          PROJECT="${{ steps.deploy-values.outputs.PROJECT }}"
          SERVICE="${{ env.BACKEND_SERVICE }}"
          PORT="${{ env.BACKEND_PORT }}"
          IMAGE="${{ steps.deploy-values.outputs.BACKEND_IMAGE }}"
          
          echo "üöÄ Deploying backend..."
          echo "  Service: $SERVICE"
          echo "  Image: $IMAGE"
          echo "  Region: $REGION"
          echo "  Port: $PORT"
          
          gcloud run deploy $SERVICE \
            --image="$IMAGE" \
            --platform=managed \
            --region=$REGION \
            --allow-unauthenticated \
            --port=$PORT \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --timeout=300 \
            --project=$PROJECT \
            --set-env-vars="NODE_ENV=production,PORT=$PORT,SUPABASE_URL=${{ secrets.SUPABASE_URL }},SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }},JWT_SECRET=${{ secrets.JWT_SECRET }},CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }},CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }},CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }},CLIENT_URL=${{ secrets.CLIENT_URL || 'https://yugayatra-frontend-xxxxx-uc.a.run.app' }}" \
            --quiet
          
          # Get service URL
          BACKEND_URL=$(gcloud run services describe $SERVICE \
            --platform=managed \
            --region=$REGION \
            --format="value(status.url)" \
            --project=$PROJECT)
          
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Backend deployed at: $BACKEND_URL"

      - name: Health check backend
        run: |
          BACKEND_URL="${{ steps.deploy-backend.outputs.url }}"
          echo "üè• Checking backend health..."
          
          # Wait for service to be ready
          sleep 10
          
          # Try health check
          for i in {1..5}; do
            if curl -f -s "${BACKEND_URL}/health" > /dev/null; then
              echo "‚úÖ Backend is healthy!"
              exit 0
            fi
            echo "‚è≥ Attempt $i/5: Waiting for backend to be ready..."
            sleep 5
          done
          
          echo "‚ö†Ô∏è  Backend health check failed, but deployment succeeded"
          echo "   URL: ${BACKEND_URL}/health"

  # Deploy Frontend
  deploy-frontend:
    name: Deploy Frontend to Cloud Run
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-backend]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Set deployment values
        id: deploy-values
        run: |
          set -e
          
          # Read secrets with fallbacks
          REGION="${{ secrets.GCP_REGION }}"
          PROJECT="${{ secrets.GCP_PROJECT_ID }}"
          REPO="${{ secrets.GCP_ARTIFACT_REGISTRY }}"
          
          # Remove whitespace
          REGION=$(echo "$REGION" | xargs)
          PROJECT=$(echo "$PROJECT" | xargs)
          REPO=$(echo "$REPO" | xargs)
          
          # Apply defaults
          if [ -z "$REGION" ] || [ "$REGION" = "null" ] || [ "$REGION" = "" ]; then
            REGION="${{ env.GCP_REGION }}"
          fi
          
          if [ -z "$PROJECT" ] || [ "$PROJECT" = "null" ] || [ "$PROJECT" = "" ]; then
            PROJECT="${{ env.GCP_PROJECT_ID }}"
          fi
          
          if [ -z "$REPO" ] || [ "$REPO" = "null" ] || [ "$REPO" = "" ]; then
            REPO="${{ env.GCP_ARTIFACT_REGISTRY }}"
          fi
          
          # Build image tag
          FRONTEND_IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/frontend:${GITHUB_SHA}"
          
          # Validate tag
          if [[ "$FRONTEND_IMAGE" == -* ]]; then
            echo "‚ùå ERROR: Image tag starts with dash! REGION is missing."
            exit 1
          fi
          
          echo "REGION=$REGION" >> $GITHUB_OUTPUT
          echo "PROJECT=$PROJECT" >> $GITHUB_OUTPUT
          echo "REPO=$REPO" >> $GITHUB_OUTPUT
          echo "FRONTEND_IMAGE=$FRONTEND_IMAGE" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Deployment values:"
          echo "  REGION=$REGION"
          echo "  PROJECT=$PROJECT"
          echo "  FRONTEND_IMAGE=$FRONTEND_IMAGE"

      - name: Get Backend URL
        id: backend-url
        run: |
          REGION="${{ steps.deploy-values.outputs.REGION }}"
          PROJECT="${{ steps.deploy-values.outputs.PROJECT }}"
          SERVICE="${{ env.BACKEND_SERVICE }}"
          
          BACKEND_URL=$(gcloud run services describe $SERVICE \
            --platform=managed \
            --region=$REGION \
            --format="value(status.url)" \
            --project=$PROJECT)
          
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "Backend URL: $BACKEND_URL"

      - name: Deploy Frontend to Cloud Run
        id: deploy-frontend
        run: |
          set -e
          
          REGION="${{ steps.deploy-values.outputs.REGION }}"
          PROJECT="${{ steps.deploy-values.outputs.PROJECT }}"
          SERVICE="${{ env.FRONTEND_SERVICE }}"
          PORT="${{ env.FRONTEND_PORT }}"
          IMAGE="${{ steps.deploy-values.outputs.FRONTEND_IMAGE }}"
          BACKEND_URL="${{ steps.backend-url.outputs.url }}"
          
          echo "üöÄ Deploying frontend..."
          echo "  Service: $SERVICE"
          echo "  Image: $IMAGE"
          echo "  Region: $REGION"
          echo "  Port: $PORT"
          echo "  Backend URL: $BACKEND_URL"
          
          gcloud run deploy $SERVICE \
            --image="$IMAGE" \
            --platform=managed \
            --region=$REGION \
            --allow-unauthenticated \
            --port=$PORT \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --timeout=300 \
            --project=$PROJECT \
            --set-env-vars="NODE_ENV=production,PORT=$PORT,NEXT_PUBLIC_API_BASE_URL=${BACKEND_URL}/api" \
            --quiet
          
          # Get service URL
          FRONTEND_URL=$(gcloud run services describe $SERVICE \
            --platform=managed \
            --region=$REGION \
            --format="value(status.url)" \
            --project=$PROJECT)
          
          echo "url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Frontend deployed at: $FRONTEND_URL"

      - name: Update Backend CLIENT_URL
        run: |
          REGION="${{ steps.deploy-values.outputs.REGION }}"
          PROJECT="${{ steps.deploy-values.outputs.PROJECT }}"
          BACKEND_SERVICE="${{ env.BACKEND_SERVICE }}"
          FRONTEND_URL="${{ steps.deploy-frontend.outputs.url }}"
          
          echo "üîÑ Updating backend CLIENT_URL to: $FRONTEND_URL"
          
          gcloud run services update $BACKEND_SERVICE \
            --update-env-vars="CLIENT_URL=$FRONTEND_URL" \
            --platform=managed \
            --region=$REGION \
            --project=$PROJECT \
            --quiet
          
          echo "‚úÖ Backend CLIENT_URL updated"

      - name: Health check frontend
        run: |
          FRONTEND_URL="${{ steps.deploy-frontend.outputs.url }}"
          echo "üè• Checking frontend health..."
          
          # Wait for service to be ready
          sleep 10
          
          # Try health check
          for i in {1..5}; do
            if curl -f -s "$FRONTEND_URL" > /dev/null; then
              echo "‚úÖ Frontend is healthy!"
              exit 0
            fi
            echo "‚è≥ Attempt $i/5: Waiting for frontend to be ready..."
            sleep 5
          done
          
          echo "‚ö†Ô∏è  Frontend health check failed, but deployment succeeded"
          echo "   URL: $FRONTEND_URL"

  # Deployment Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 5
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Get Service URLs
        run: |
          # Read secrets with fallbacks
          REGION="${{ secrets.GCP_REGION }}"
          PROJECT="${{ secrets.GCP_PROJECT_ID }}"
          
          # Remove whitespace
          REGION=$(echo "$REGION" | xargs)
          PROJECT=$(echo "$PROJECT" | xargs)
          
          # Apply defaults
          if [ -z "$REGION" ] || [ "$REGION" = "null" ] || [ "$REGION" = "" ]; then
            REGION="${{ env.GCP_REGION }}"
          fi
          
          if [ -z "$PROJECT" ] || [ "$PROJECT" = "null" ] || [ "$PROJECT" = "" ]; then
            PROJECT="${{ env.GCP_PROJECT_ID }}"
          fi
          
          BACKEND_SERVICE="${{ env.BACKEND_SERVICE }}"
          FRONTEND_SERVICE="${{ env.FRONTEND_SERVICE }}"
          
          BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE \
            --platform=managed \
            --region=$REGION \
            --format="value(status.url)" \
            --project=$PROJECT)
          
          FRONTEND_URL=$(gcloud run services describe $FRONTEND_SERVICE \
            --platform=managed \
            --region=$REGION \
            --format="value(status.url)" \
            --project=$PROJECT)
          
          echo "=========================================="
          echo "‚úÖ DEPLOYMENT COMPLETE!"
          echo "=========================================="
          echo ""
          echo "üì¶ Services Deployed:"
          echo "  Backend:  $BACKEND_URL"
          echo "  Frontend: $FRONTEND_URL"
          echo ""
          echo "üîó Health Checks:"
          echo "  Backend:  $BACKEND_URL/health"
          echo "  Frontend: $FRONTEND_URL"
          echo ""
          echo "üìä Deployment Info:"
          echo "  Commit: ${{ github.sha }}"
          echo "  Author: ${{ github.actor }}"
          echo "  Branch: ${{ github.ref_name }}"
          echo "=========================================="
