name: Validate Configuration & Secrets

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/validate-config.yml'
  schedule:
    # Run daily at 2 AM UTC to catch any issues
    - cron: '0 2 * * *'

env:
  NODE_VERSION: "20"
  BACKEND_SERVICE: yugayatra-backend
  FRONTEND_SERVICE: yugayatra-frontend
  GCP_REGION: us-central1
  GCP_PROJECT_ID: yugayatraretail
  GCP_ARTIFACT_REGISTRY: yugayatraretail
  BACKEND_PORT: 5001
  FRONTEND_PORT: 3000

jobs:
  validate-secrets:
    name: Validate Secrets & Variables
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Validate Required Secrets
        id: required-secrets
        run: |
          set -eo pipefail

          ERRORS=0
          WARNINGS=0

          echo "=========================================="
          echo "üîç Validating Required Secrets"
          echo "=========================================="

          GCP_KEY_FILE="/tmp/gcp_sa_key.json"
          TMP_GCP_KEY="/tmp/gcp_sa_key.secret"

          # Safely write the multi-line secret to a file without interpreting characters.
          cat <<'EOF' > "$TMP_GCP_KEY"
${{ secrets.GCP_SA_KEY }}
EOF

          if grep -q '[^[:space:]]' "$TMP_GCP_KEY"; then
            mv "$TMP_GCP_KEY" "$GCP_KEY_FILE"
          else
            rm -f "$TMP_GCP_KEY"
          fi

          if [ ! -f "$GCP_KEY_FILE" ]; then
            echo "‚ùå GCP_SA_KEY: NOT SET (REQUIRED)"
            echo "   üí° Tip: Update the GCP_SA_KEY secret with the full JSON content of your service account key."
            ERRORS=$((ERRORS + 1))
          else
            LENGTH=$(wc -c < "$GCP_KEY_FILE" | tr -d ' ')
            echo "‚úÖ GCP_SA_KEY: SET (length: $LENGTH chars)"

            JSON_ERROR=$(jq -e . "$GCP_KEY_FILE" 2>&1) || true
            if jq -e . "$GCP_KEY_FILE" >/dev/null 2>&1; then
              echo "   ‚úÖ Valid JSON format"
              PROJECT_ID=$(jq -r '.project_id // empty' "$GCP_KEY_FILE" 2>/dev/null)
              CLIENT_EMAIL=$(jq -r '.client_email // empty' "$GCP_KEY_FILE" 2>/dev/null)
              [ -n "$PROJECT_ID" ] && echo "   üìã Project ID: $PROJECT_ID"
              [ -n "$CLIENT_EMAIL" ] && echo "   üìã Client Email: $CLIENT_EMAIL"
            else
              echo "   ‚ùå Invalid JSON format"
              echo "   üîç JSON Error:"
              echo "$JSON_ERROR" | head -n 3 | sed 's/^/      /'
              ERRORS=$((ERRORS + 1))
            fi

            rm -f "$GCP_KEY_FILE"
          fi

          check_secret() {
            local value="$1"
            local label="$2"
            local preview="$3"
            local min_len="$4"

            if [ -z "$value" ]; then
              echo "‚ùå $label: NOT SET (REQUIRED)"
              ERRORS=$((ERRORS + 1))
              return
            fi

            local length=${#value}
            echo "‚úÖ $label: SET"
            if [ "$preview" = "yes" ]; then
              echo "   üìã Value: $(printf '%s' "$value" | cut -c1-50)..."
            else
              echo "   üìè Length: $length chars"
            fi

            if [ -n "$min_len" ] && [ "$length" -lt "$min_len" ]; then
              echo "   ‚ö†Ô∏è  WARNING: $label should be at least $min_len characters"
              WARNINGS=$((WARNINGS + 1))
            fi
          }

          check_secret "${{ secrets.SUPABASE_URL }}" "SUPABASE_URL" "yes"
          check_secret "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" "SUPABASE_SERVICE_ROLE_KEY"
          check_secret "${{ secrets.JWT_SECRET }}" "JWT_SECRET" "" 32
          check_secret "${{ secrets.CLOUDINARY_CLOUD_NAME }}" "CLOUDINARY_CLOUD_NAME"
          check_secret "${{ secrets.CLOUDINARY_API_KEY }}" "CLOUDINARY_API_KEY"
          check_secret "${{ secrets.CLOUDINARY_API_SECRET }}" "CLOUDINARY_API_SECRET"

          echo ""
          echo "=========================================="
          echo "üìä Required Secrets Summary"
          echo "=========================================="
          echo "Errors: $ERRORS"
          echo "Warnings: $WARNINGS"
          echo "=========================================="

          echo "errors=$ERRORS" >> "$GITHUB_OUTPUT"
          echo "warnings=$WARNINGS" >> "$GITHUB_OUTPUT"

          if [ $ERRORS -gt 0 ]; then
            echo "‚ùå Validation failed: $ERRORS required secret(s) missing or invalid"
            exit 1
          else
            echo "‚úÖ All required secrets are valid!"
          fi

      - name: Validate Optional Secrets
        id: optional-secrets
        run: |
          echo "=========================================="
          echo "üîç Validating Optional Secrets"
          echo "=========================================="
          
          # Check GCP_REGION
          GCP_REGION="${{ secrets.GCP_REGION }}"
          if [ -z "$GCP_REGION" ] || [ "$GCP_REGION" = "" ]; then
            echo "‚ö†Ô∏è  GCP_REGION: Not set (will use default: ${{ env.GCP_REGION }})"
          else
            echo "‚úÖ GCP_REGION: $GCP_REGION"
          fi
          
          # Check GCP_PROJECT_ID
          GCP_PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"
          if [ -z "$GCP_PROJECT_ID" ] || [ "$GCP_PROJECT_ID" = "" ]; then
            echo "‚ö†Ô∏è  GCP_PROJECT_ID: Not set (will use default: ${{ env.GCP_PROJECT_ID }})"
          else
            echo "‚úÖ GCP_PROJECT_ID: $GCP_PROJECT_ID"
          fi
          
          # Check GCP_ARTIFACT_REGISTRY
          GCP_ARTIFACT_REGISTRY="${{ secrets.GCP_ARTIFACT_REGISTRY }}"
          if [ -z "$GCP_ARTIFACT_REGISTRY" ] || [ "$GCP_ARTIFACT_REGISTRY" = "" ]; then
            echo "‚ö†Ô∏è  GCP_ARTIFACT_REGISTRY: Not set (will use default: ${{ env.GCP_ARTIFACT_REGISTRY }})"
          else
            echo "‚úÖ GCP_ARTIFACT_REGISTRY: $GCP_ARTIFACT_REGISTRY"
          fi
          
          # Check CLIENT_URL
          CLIENT_URL=$(printf '%s' "${{ secrets.CLIENT_URL }}")
          if [ -z "${CLIENT_URL}" ]; then
            echo "‚ö†Ô∏è  CLIENT_URL: Not set (will be set automatically after frontend deployment)"
          else
            echo "‚úÖ CLIENT_URL: ${CLIENT_URL}"
          fi
          
          # Check NEXT_PUBLIC_API_BASE_URL
          NEXT_PUBLIC_API_BASE_URL=$(printf '%s' "${{ secrets.NEXT_PUBLIC_API_BASE_URL }}")
          if [ -z "${NEXT_PUBLIC_API_BASE_URL}" ]; then
            echo "‚ö†Ô∏è  NEXT_PUBLIC_API_BASE_URL: Not set (will use backend URL after deployment)"
          else
            echo "‚úÖ NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}"
          fi
          
          echo "=========================================="

      - name: Validate Environment Variables
        run: |
          echo "=========================================="
          echo "üîç Validating Environment Variables"
          echo "=========================================="
          
          echo "‚úÖ NODE_VERSION: ${{ env.NODE_VERSION }}"
          echo "‚úÖ BACKEND_SERVICE: ${{ env.BACKEND_SERVICE }}"
          echo "‚úÖ FRONTEND_SERVICE: ${{ env.FRONTEND_SERVICE }}"
          echo "‚úÖ GCP_REGION: ${{ env.GCP_REGION }}"
          echo "‚úÖ GCP_PROJECT_ID: ${{ env.GCP_PROJECT_ID }}"
          echo "‚úÖ GCP_ARTIFACT_REGISTRY: ${{ env.GCP_ARTIFACT_REGISTRY }}"
          echo "‚úÖ BACKEND_PORT: ${{ env.BACKEND_PORT }}"
          echo "‚úÖ FRONTEND_PORT: ${{ env.FRONTEND_PORT }}"
          
          echo "=========================================="

      - name: Validate Image Tag Format
        run: |
          echo "=========================================="
          echo "üîç Validating Image Tag Format"
          echo "=========================================="
          
          # Get values with fallbacks
          REGION="${{ secrets.GCP_REGION }}"
          PROJECT="${{ secrets.GCP_PROJECT_ID }}"
          REPO="${{ secrets.GCP_ARTIFACT_REGISTRY }}"
          
          REGION=$(echo "$REGION" | xargs)
          PROJECT=$(echo "$PROJECT" | xargs)
          REPO=$(echo "$REPO" | xargs)
          
          if [ -z "$REGION" ] || [ "$REGION" = "null" ] || [ "$REGION" = "" ]; then
            REGION="${{ env.GCP_REGION }}"
          fi
          
          if [ -z "$PROJECT" ] || [ "$PROJECT" = "null" ] || [ "$PROJECT" = "" ]; then
            PROJECT="${{ env.GCP_PROJECT_ID }}"
          fi
          
          if [ -z "$REPO" ] || [ "$REPO" = "null" ] || [ "$REPO" = "" ]; then
            REPO="${{ env.GCP_ARTIFACT_REGISTRY }}"
          fi
          
          # Build sample tags
          BACKEND_TAG="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/backend:test"
          FRONTEND_TAG="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/frontend:test"
          
          echo "Backend tag format: $BACKEND_TAG"
          echo "Frontend tag format: $FRONTEND_TAG"
          
          # Validate tags don't start with dash
          if [[ "$BACKEND_TAG" == -* ]] || [[ "$FRONTEND_TAG" == -* ]]; then
            echo "‚ùå ERROR: Image tag starts with dash! REGION is missing."
            exit 1
          fi
          
          # Validate format
          if [[ ! "$BACKEND_TAG" =~ ^[a-z0-9-]+-docker\.pkg\.dev/[a-z0-9-]+/[a-z0-9-]+/backend:.+$ ]]; then
            echo "‚ùå ERROR: Invalid backend tag format"
            exit 1
          fi
          
          if [[ ! "$FRONTEND_TAG" =~ ^[a-z0-9-]+-docker\.pkg\.dev/[a-z0-9-]+/[a-z0-9-]+/frontend:.+$ ]]; then
            echo "‚ùå ERROR: Invalid frontend tag format"
            exit 1
          fi
          
          echo "‚úÖ Image tag format is valid"
          echo "=========================================="

  validate-gcp-connection:
    name: Validate GCP Connection
    runs-on: ubuntu-latest
    needs: validate-secrets
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Validate GCP Authentication
        run: |
          echo "=========================================="
          echo "üîç Validating GCP Authentication"
          echo "=========================================="
          
          # Get current account
          ACCOUNT=$(gcloud auth list --filter=status:ACTIVE --format="value(account)")
          if [ -z "$ACCOUNT" ]; then
            echo "‚ùå No active GCP account found"
            exit 1
          fi
          
          echo "‚úÖ Authenticated as: $ACCOUNT"
          echo "=========================================="

      - name: Validate GCP Project Access
        run: |
          echo "=========================================="
          echo "üîç Validating GCP Project Access"
          echo "=========================================="
          
          # Get values with fallbacks
          REGION="${{ secrets.GCP_REGION }}"
          PROJECT="${{ secrets.GCP_PROJECT_ID }}"
          
          REGION=$(echo "$REGION" | xargs)
          PROJECT=$(echo "$PROJECT" | xargs)
          
          if [ -z "$REGION" ] || [ "$REGION" = "null" ] || [ "$REGION" = "" ]; then
            REGION="${{ env.GCP_REGION }}"
          fi
          
          if [ -z "$PROJECT" ] || [ "$PROJECT" = "null" ] || [ "$PROJECT" = "" ]; then
            PROJECT="${{ env.GCP_PROJECT_ID }}"
          fi
          
          # Set project
          gcloud config set project $PROJECT
          
          # Verify project access
          PROJECT_INFO=$(gcloud projects describe $PROJECT --format="value(projectId,name)" 2>&1)
          if [ $? -ne 0 ]; then
            echo "‚ùå Cannot access project: $PROJECT"
            echo "$PROJECT_INFO"
            exit 1
          fi
          
          echo "‚úÖ Project accessible: $PROJECT"
          echo "   Project info: $PROJECT_INFO"
          
          # Check if required APIs are enabled
          echo ""
          echo "Checking required APIs..."
          
          # Cloud Run API
          if gcloud services list --enabled --filter="name:run.googleapis.com" --format="value(name)" | grep -q "run.googleapis.com"; then
            echo "‚úÖ Cloud Run API: Enabled"
          else
            echo "‚ùå Cloud Run API: Not enabled"
            exit 1
          fi
          
          # Artifact Registry API
          if gcloud services list --enabled --filter="name:artifactregistry.googleapis.com" --format="value(name)" | grep -q "artifactregistry.googleapis.com"; then
            echo "‚úÖ Artifact Registry API: Enabled"
          else
            echo "‚ùå Artifact Registry API: Not enabled"
            exit 1
          fi
          
          echo "=========================================="

      - name: Validate Artifact Registry Access
        run: |
          echo "=========================================="
          echo "üîç Validating Artifact Registry Access"
          echo "=========================================="
          
          # Get values with fallbacks
          REGION="${{ secrets.GCP_REGION }}"
          PROJECT="${{ secrets.GCP_PROJECT_ID }}"
          REPO="${{ secrets.GCP_ARTIFACT_REGISTRY }}"
          
          REGION=$(echo "$REGION" | xargs)
          PROJECT=$(echo "$PROJECT" | xargs)
          REPO=$(echo "$REPO" | xargs)
          
          if [ -z "$REGION" ] || [ "$REGION" = "null" ] || [ "$REGION" = "" ]; then
            REGION="${{ env.GCP_REGION }}"
          fi
          
          if [ -z "$PROJECT" ] || [ "$PROJECT" = "null" ] || [ "$PROJECT" = "" ]; then
            PROJECT="${{ env.GCP_PROJECT_ID }}"
          fi
          
          if [ -z "$REPO" ] || [ "$REPO" = "null" ] || [ "$REPO" = "" ]; then
            REPO="${{ env.GCP_ARTIFACT_REGISTRY }}"
          fi
          
          # Configure Docker
          gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet
          
          # Check if repository exists
          REPO_PATH="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}"
          if gcloud artifacts repositories describe $REPO --location=$REGION --format="value(name)" 2>/dev/null | grep -q "$REPO"; then
            echo "‚úÖ Artifact Registry repository exists: $REPO_PATH"
          else
            echo "‚ö†Ô∏è  Artifact Registry repository not found: $REPO_PATH"
            echo "   Repository will be created on first push"
          fi
          
          echo "=========================================="

      - name: Validate Cloud Run Services
        run: |
          echo "=========================================="
          echo "üîç Validating Cloud Run Services"
          echo "=========================================="
          
          # Get values with fallbacks
          REGION="${{ secrets.GCP_REGION }}"
          PROJECT="${{ secrets.GCP_PROJECT_ID }}"
          BACKEND_SERVICE="${{ env.BACKEND_SERVICE }}"
          FRONTEND_SERVICE="${{ env.FRONTEND_SERVICE }}"
          
          REGION=$(echo "$REGION" | xargs)
          PROJECT=$(echo "$PROJECT" | xargs)
          
          if [ -z "$REGION" ] || [ "$REGION" = "null" ] || [ "$REGION" = "" ]; then
            REGION="${{ env.GCP_REGION }}"
          fi
          
          if [ -z "$PROJECT" ] || [ "$PROJECT" = "null" ] || [ "$PROJECT" = "" ]; then
            PROJECT="${{ env.GCP_PROJECT_ID }}"
          fi
          
          # Check backend service
          if gcloud run services describe $BACKEND_SERVICE --region=$REGION --format="value(metadata.name)" 2>/dev/null | grep -q "$BACKEND_SERVICE"; then
            echo "‚úÖ Backend service exists: $BACKEND_SERVICE"
            BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE --region=$REGION --format="value(status.url)" 2>/dev/null)
            if [ -n "$BACKEND_URL" ]; then
              echo "   URL: $BACKEND_URL"
            fi
          else
            echo "‚ÑπÔ∏è  Backend service not found: $BACKEND_SERVICE (will be created on first deployment)"
          fi
          
          # Check frontend service
          if gcloud run services describe $FRONTEND_SERVICE --region=$REGION --format="value(metadata.name)" 2>/dev/null | grep -q "$FRONTEND_SERVICE"; then
            echo "‚úÖ Frontend service exists: $FRONTEND_SERVICE"
            FRONTEND_URL=$(gcloud run services describe $FRONTEND_SERVICE --region=$REGION --format="value(status.url)" 2>/dev/null)
            if [ -n "$FRONTEND_URL" ]; then
              echo "   URL: $FRONTEND_URL"
            fi
          else
            echo "‚ÑπÔ∏è  Frontend service not found: $FRONTEND_SERVICE (will be created on first deployment)"
          fi
          
          echo "=========================================="

  validate-docker-builds:
    name: Validate Docker Builds
    runs-on: ubuntu-latest
    needs: validate-secrets
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Backend Dockerfile
        run: |
          echo "=========================================="
          echo "üîç Validating Backend Dockerfile"
          echo "=========================================="
          
          if [ ! -f "./backend/Dockerfile" ]; then
            echo "‚ùå Backend Dockerfile not found"
            exit 1
          fi
          
          echo "‚úÖ Backend Dockerfile exists"
          
          # Check if Dockerfile is valid (basic syntax check)
          if docker buildx build --dry-run -f ./backend/Dockerfile ./backend 2>&1 | grep -q "error"; then
            echo "‚ùå Backend Dockerfile has syntax errors"
            exit 1
          fi
          
          echo "‚úÖ Backend Dockerfile syntax is valid"
          echo "=========================================="

      - name: Validate Frontend Dockerfile
        run: |
          echo "=========================================="
          echo "üîç Validating Frontend Dockerfile"
          echo "=========================================="
          
          if [ ! -f "./frontend/Dockerfile" ]; then
            echo "‚ùå Frontend Dockerfile not found"
            exit 1
          fi
          
          echo "‚úÖ Frontend Dockerfile exists"
          
          # Check if Dockerfile is valid (basic syntax check)
          if docker buildx build --dry-run -f ./frontend/Dockerfile ./frontend 2>&1 | grep -q "error"; then
            echo "‚ùå Frontend Dockerfile has syntax errors"
            exit 1
          fi
          
          echo "‚úÖ Frontend Dockerfile syntax is valid"
          echo "=========================================="

      - name: Test Backend Docker Build (Dry Run)
        run: |
          echo "=========================================="
          echo "üîç Testing Backend Docker Build"
          echo "=========================================="
          
          # Test build without pushing
          docker buildx build \
            --load \
            --tag test-backend:latest \
            -f ./backend/Dockerfile \
            ./backend 2>&1 | head -20
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Backend Docker build test passed"
          else
            echo "‚ùå Backend Docker build test failed"
            exit 1
          fi
          
          echo "=========================================="

      - name: Test Frontend Docker Build (Dry Run)
        run: |
          echo "=========================================="
          echo "üîç Testing Frontend Docker Build"
          echo "=========================================="
          
          # Test build without pushing
          docker buildx build \
            --load \
            --tag test-frontend:latest \
            -f ./frontend/Dockerfile \
            --build-arg NEXT_PUBLIC_API_BASE_URL=http://localhost:5001/api \
            ./frontend 2>&1 | head -20
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Frontend Docker build test passed"
          else
            echo "‚ùå Frontend Docker build test failed"
            exit 1
          fi
          
          echo "=========================================="

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-secrets, validate-gcp-connection, validate-docker-builds]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "=========================================="
          echo "üìä VALIDATION SUMMARY"
          echo "=========================================="
          echo ""
          echo "‚úÖ Secrets Validation: ${{ needs.validate-secrets.result }}"
          echo "‚úÖ GCP Connection: ${{ needs.validate-gcp-connection.result }}"
          echo "‚úÖ Docker Builds: ${{ needs.validate-docker-builds.result }}"
          echo ""
          
          if [ "${{ needs.validate-secrets.result }}" = "success" ] && \
             [ "${{ needs.validate-gcp-connection.result }}" = "success" ] && \
             [ "${{ needs.validate-docker-builds.result }}" = "success" ]; then
            echo "üéâ ALL VALIDATIONS PASSED!"
            echo ""
            echo "Your configuration is ready for deployment."
            echo "You can now run the deploy-gcp.yml workflow."
          else
            echo "‚ùå SOME VALIDATIONS FAILED"
            echo ""
            echo "Please check the failed jobs above and fix the issues."
            exit 1
          fi
          
          echo "=========================================="

